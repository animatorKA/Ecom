<?php
// Set page info first so admin_header can use it
$page_title = "Dashboard";
$page_icon = "bi-speedometer2";
$active_nav = "dashboard";
$page_subtitle = "Store Overview and Statistics";

// Include required files
require_once __DIR__ . '/admin_functions.php';  // This will include config.php and auth.php

// Set no-cache headers for admin pages
header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
header('Pragma: no-cache');
header('Expires: Sat, 26 Jul 1997 05:00:00 GMT');

// Verify admin role
requireRole('admin');

// Include the admin header
require_once __DIR__ . '/admin_header.php';
$page_title = "Dashboard";
$page_icon = "bi-speedometer2";
$active_nav = 'dashboard';
$page_subtitle = "Store Overview and Statistics";

// Get messages from session
$success = getSuccessMessage();
$error = getErrorMessage();

// Get statistics
$stats = [
    'users' => 0,
    'products' => 0,
    'orders' => 0,
    'unreadMessages' => 0,
    'recentOrders' => [],
    'month_orders' => 0,
    'month_revenue' => 0,
    'month_customers' => 0,
    'today_orders' => 0,
    'today_revenue' => 0
];

// Get today's stats
$today = date('Y-m-d');
$todayStats = $pdo->query("
    SELECT COUNT(*) as order_count, 
           COALESCE(SUM(total_amount), 0) as revenue
    FROM orders 
    WHERE DATE(created_at) = '$today'"
)->fetch(PDO::FETCH_ASSOC);

$stats['today_orders'] = $todayStats['order_count'];
$stats['today_revenue'] = $todayStats['revenue'];

// Get monthly stats
$monthStart = date('Y-m-01');
$monthEnd = date('Y-m-t');
$monthlyStats = $pdo->query("
    SELECT COUNT(*) as order_count,
           COALESCE(SUM(total_amount), 0) as revenue,
           COUNT(DISTINCT user_id) as unique_customers
    FROM orders
    WHERE DATE(created_at) BETWEEN '$monthStart' AND '$monthEnd'"
)->fetch(PDO::FETCH_ASSOC);

$stats['month_orders'] = $monthlyStats['order_count'];
$stats['month_revenue'] = $monthlyStats['revenue'];
$stats['month_customers'] = $monthlyStats['unique_customers'];

// Get inventory stats
$inventoryStats = $pdo->query("
    SELECT COUNT(*) as total_products,
           COUNT(CASE WHEN stock <= 5 THEN 1 END) as low_stock_count,
           SUM(stock) as total_stock
    FROM products"
)->fetch(PDO::FETCH_ASSOC);

// Set low stock products count
$lowStockProducts = $inventoryStats['low_stock_count'];

// Get users count
$result = $pdo->query("SELECT COUNT(*) FROM users");
$stats['users'] = $result ? $result->fetchColumn() : 0;

// Get products count
$result = $pdo->query("SELECT COUNT(*) FROM products");
$stats['products'] = $result ? $result->fetchColumn() : 0;

// Get orders count
$result = $pdo->query("SELECT COUNT(*) FROM orders");
$stats['orders'] = $result ? $result->fetchColumn() : 0;

// Get unread messages count
$result = $pdo->query("SELECT COUNT(*) FROM messages WHERE status = 'new'");
$stats['unreadMessages'] = $result ? $result->fetchColumn() : 0;
$newMessagesCount = $stats['unreadMessages'];  // Set this for consistency with the template

// Get recent orders with customer details
$sql = "SELECT o.*, u.name as customer_name, u.email as customer_email
        FROM orders o
        JOIN users u ON o.user_id = u.user_id
        ORDER BY o.created_at DESC
        LIMIT 5";
$stmt = $pdo->query($sql);
$stats['recentOrders'] = $stmt ? $stmt->fetchAll(PDO::FETCH_ASSOC) : [];
?>

<?php 
// Include the admin header which has all necessary HTML head elements
require_once 'admin_header.php';
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar Toggle Button -->
        <button id="sidebarToggle" class="sidebar-toggle-btn">
            <i class="bi bi-list"></i>
        </button>

        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <div class="d-flex flex-column h-100">
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-shield-check fs-4 text-success me-2"></i>
                        <div>
                            <div class="fw-semibold">Admin Panel</div>
                            <small class="text-muted">Store Management</small>
                        </div>
                    </div>
                </div>
            
                <div class="nav flex-column gap-1">
                    <a href="/pns_store/admin/dashboard.php" class="nav-link active px-3 py-2 rounded">
                        <i class="bi bi-speedometer2 me-2"></i>
                        Dashboard
                    </a>
                    <a href="/pns_store/admin/products.php" class="nav-link px-3 py-2 rounded">
                        <i class="bi bi-box me-2"></i>
                        Products
                    </a>
                    <a href="/pns_store/admin/categories.php" class="nav-link px-3 py-2 rounded">
                        <i class="bi bi-tags me-2"></i>
                        Categories
                    </a>
                    <a href="/pns_store/admin/orders.php" class="nav-link px-3 py-2 rounded">
                        <i class="bi bi-cart me-2"></i>
                        Orders
                    </a>
                    <a href="/pns_store/admin/organizations.php" class="nav-link px-3 py-2 rounded">
                        <i class="bi bi-building me-2"></i>
                        Organizations
                    </a>
                    <a href="/pns_store/admin/messages.php" class="nav-link px-3 py-2 rounded d-flex align-items-center">
                        <i class="bi bi-envelope me-2"></i>
                        Messages
                        <?php if ($stats['unreadMessages'] > 0): ?>
                            <span class="badge text-bg-danger ms-auto rounded-pill"><?= $stats['unreadMessages'] ?></span>
                        <?php endif; ?>
                    </a>
                    <a href="/pns_store/admin/users.php" class="nav-link px-3 py-2 rounded">
                        <i class="bi bi-people me-2"></i>
                        Users
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-container">
                <div class="dashboard-content">
                    <!-- Page Header -->
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard Overview
                        </h1>
                        <p class="text-muted mb-0">Welcome back, let's check your store's performance</p>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="stats-overview">
                    <!-- Total Products -->
                    <div class="stat-card primary" style="animation-delay: 0.1s">
                        <div class="icon">
                            <i class="bi bi-box"></i>
                        </div>
                        <div class="value"><?= number_format($stats['products']) ?></div>
                        <div class="label">Total Products</div>
                    </div>

                    <!-- Total Orders -->
                    <div class="stat-card success" style="animation-delay: 0.2s">
                        <div class="icon">
                            <i class="bi bi-cart"></i>
                        </div>
                        <div class="value"><?= number_format($stats['orders']) ?></div>
                        <div class="label">Total Orders</div>
                    </div>

                    <!-- Total Users -->
                    <div class="stat-card info" style="animation-delay: 0.3s">
                        <div class="icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="value"><?= number_format($stats['users']) ?></div>
                        <div class="label">Active Users</div>
                    </div>

                    <!-- Unread Messages -->
                    <div class="stat-card warning" style="animation-delay: 0.4s">
                        <div class="icon">
                            <i class="bi bi-envelope"></i>
                        </div>
                        <div class="value"><?= number_format($stats['unreadMessages']) ?></div>
                        <div class="label">New Messages</div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="recent-orders">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="bi bi-clock-history"></i>
                            Recent Orders
                        </h2>
                        <a href="/pns_store/admin/orders.php" class="btn btn-outline-primary">
                            View All Orders
                        </a>
                    </div>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                                                                <tbody>
                                    <?php foreach ($stats['recentOrders'] as $order): ?>
                                    <tr>
                                        <td>#<?= $order['order_id'] ?></td>
                                        <td>
                                            <div class="fw-medium"><?= htmlspecialchars($order['customer_name']) ?></div>
                                            <small class="text-muted"><?= htmlspecialchars($order['customer_email']) ?></small>
                                        </td>
                                        <td>
                                            <span class="status-badge <?= strtolower($order['status']) ?>">
                                                <?= ucfirst($order['status']) ?>
                                            </span>
                                        </td>
                                        <td>₱<?= number_format($order['total_amount'], 2) ?></td>
                                        <td><?= date('M j, Y', strtotime($order['created_at'])) ?></td>
                                    </tr>
                                    <?php endforeach; ?>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get the sidebar toggle button, sidebar, and main content elements
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.admin-sidebar');
        const mainContent = document.querySelector('.admin-main');

        // Add click event listener to toggle button
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            
            // Store the sidebar state in localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });

        // Check localStorage for saved sidebar state on page load
        document.addEventListener('DOMContentLoaded', () => {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            }
        });
    </script>
</body>
</html>

                <!-- Quick Stats -->
                <div class="row g-4 mb-4">
                    <!-- Today's Orders -->
                    <div class="col-lg-3 col-md-6">
                        <div class="admin-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                                        <i class="bi bi-cart3 text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <p class="text-muted mb-0">Today's Orders</p>
                                        <h3 class="mb-0"><?= number_format($todayStats['order_count']) ?></h3>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- Low Stock Products -->
                    <div class="col-lg-3 col-md-6">
                        <div class="admin-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-warning bg-opacity-10 rounded p-3 me-3">
                                        <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <p class="text-muted mb-0">Low Stock Items</p>
                                        <h3 class="mb-0"><?= number_format($lowStockProducts) ?></h3>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 40%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Messages -->
                    <div class="col-lg-3 col-md-6">
                        <div class="admin-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                    <div class="bg-info bg-opacity-10 rounded p-3 me-3">
                        <i class="bi bi-envelope text-info fs-4"></i>
                    </div>
                    <div>
                        <p class="text-muted mb-0">New Messages</p>
                        <h3 class="mb-0"><?= number_format($newMessagesCount) ?></h3>
                    </div>
                </div>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar bg-info" style="width: 50%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

                    </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="admin-card">
            <div class="card-body">
                <h5 class="card-title">
                    Quick Actions
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2" style="font-size: 0.75rem; font-weight: 500;">Most Used</span>
                </h5>
                <div class="quick-actions">
                    <a href="products.php?action=new" class="quick-action-link">
                        <i class="bi bi-plus-circle"></i>
                        <span>Add New Product</span>
                    </a>
                    <a href="products.php" class="quick-action-link">
                        <i class="bi bi-box"></i>
                        <span>Manage Products</span>
                    </a>
                    <a href="orders.php" class="quick-action-link">
                        <i class="bi bi-cart-check"></i>
                        <span>Process Orders</span>
                    </a>
                    <a href="messages.php" class="quick-action-link">
                        <i class="bi bi-envelope"></i>
                        <span>View Messages</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row g-4">
    <div class="col-md-12">
      <h4 class="fw-bold mb-4" style="font-size: 1.5rem;">Statistics Overview</h4>
    </div>
    <!-- Today's Orders -->
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-cart text-success fs-4"></i>
            </div>
            <div>
              <p class="text-muted mb-1" style="font-size: 0.875rem;">Today's Orders</p>
              <h3 class="fw-bold mb-0" style="font-size: 2rem;"><?= number_format($todayStats['order_count']) ?></h3>
            </div>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Revenue -->
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-cash-stack text-primary fs-4"></i>s
            </div>
            <div>
              <p class="text-muted small mb-0">Today's Revenue</p>
              <h3 class="fw-bold mb-0">₱<?= number_format($todayStats['revenue'], 2) ?></h3>
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-primary" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Low Stock Alert -->
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
            </div>
            <div>
              <p class="text-muted small mb-0">Low Stock Items</p>
              <h3 class="fw-bold mb-0"><?= number_format($lowStockProducts) ?></h3>
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-warning" style="width: <?= min(($lowStockProducts / 10) * 100, 100) ?>%"></div>
          </div>
          <?php if ($lowStockProducts > 0): ?>
            <a href="products.php?filter=low_stock" class="btn btn-link btn-sm text-warning p-0 mt-2">
              View Low Stock Items <i class="bi bi-arrow-right ms-1"></i>
            </a>
          <?php endif; ?>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-<?= $newMessagesCount > 0 ? 'danger' : 'secondary' ?> bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-envelope text-<?= $newMessagesCount > 0 ? 'danger' : 'secondary' ?> fs-4"></i>
            </div>
            <div>
              <p class="text-muted small mb-0">Unread Messages</p>
              <h3 class="fw-bold mb-0"><?= number_format($newMessagesCount) ?></h3>
            </div>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-<?= $newMessagesCount > 0 ? 'danger' : 'secondary' ?>" 
                 style="width: <?= $newMessagesCount > 0 ? '100' : '0' ?>%"></div>
          </div>
          <?php if ($newMessagesCount > 0): ?>
            <a href="messages.php" class="btn btn-link btn-sm text-danger p-0 mt-2">
              View Messages <i class="bi bi-arrow-right ms-1"></i>
            </a>
          <?php endif; ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Orders -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Active Users</h6>
              <?php
                try {
                    $activeUsers = $pdo->query("
                        SELECT COUNT(*) FROM users 
                        WHERE status = 'active' OR status IS NULL
                    ")->fetchColumn();
                    echo "<h3 class='mb-0'>" . number_format($activeUsers) . "</h3>";
                } catch (PDOException $e) {
                    echo "<h3 class='mb-0'>--</h3>";
                }
              ?>
            </div>
            <div class="bg-white bg-opacity-25 rounded-circle p-3">
              <i class="bi bi-people text-white fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-box-seam text-success fs-4"></i>
            </div>
            <div>
              <h6 class="mb-1">Products</h6>
              <?php
              try {
                $stmt = $pdo->query("SELECT COUNT(*) FROM products");
                $productCount = $stmt->fetchColumn();
                echo "<h4 class='mb-0'>" . number_format($productCount) . "</h4>";
              } catch (PDOException $e) {
                echo "<h4 class='mb-0'>--</h4>";
              }
              ?>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-cart-check text-success fs-4"></i>
            </div>
            <div>
              <h6 class="mb-1">Orders</h6>
              <?php
              try {
                $stmt = $pdo->query("SELECT COUNT(*) FROM orders");
                $orderCount = $stmt->fetchColumn();
                echo "<h4 class='mb-0'>" . number_format($orderCount) . "</h4>";
              } catch (PDOException $e) {
                echo "<h4 class='mb-0'>--</h4>";
              }
              ?>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-people text-success fs-4"></i>
            </div>
            <div>
              <h6 class="mb-1">Users</h6>
              <?php
              try {
                $stmt = $pdo->query("SELECT COUNT(*) FROM users");
                $userCount = $stmt->fetchColumn();
                echo "<h4 class='mb-0'>" . number_format($userCount) . "</h4>";
              } catch (PDOException $e) {
                echo "<h4 class='mb-0'>--</h4>";
              }
              ?>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
  <!-- Recent Orders -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="fw-bold mb-1" style="font-size: 1.5rem;">Recent Orders</h4>
              <p class="text-muted mb-0" style="font-size: 0.875rem;">Overview of the latest transactions</p>
            </div>
            <a href="orders.php" class="btn btn-light px-4">
              View All Orders <i class="bi bi-arrow-right ms-2"></i>
            </a>
          </div>
        </div>
        <div class="card-body px-0 py-2">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="py-3 px-4" style="font-size: 0.875rem; font-weight: 600;">Order ID</th>
                  <th class="py-3">Customer</th>
                  <th class="py-3">Date</th>
                  <th class="py-3">Total</th>
                  <th class="py-3">Status</th>
                  <th class="py-3">Action</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach ($stats['recentOrders'] as $order): ?>
                  <tr>
                    <td class="px-4">
                      <span class="fw-semibold" style="font-size: 0.9375rem;">#<?= $order['order_id'] ?></span>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle p-2 me-3">
                          <i class="bi bi-person text-secondary"></i>
                        </div>
                        <span class="fw-medium" style="font-size: 0.9375rem;"><?= htmlspecialchars($order['customer_name']) ?></span>
                      </div>
                    </td>
                    <td>
                      <span class="text-muted">
                        <?= date('M d, Y', strtotime($order['order_date'])) ?>
                      </span>
                    </td>
                    <td>
                      <span class="fw-medium">₱<?= number_format($order['total_amount'], 2) ?></span>
                    </td>
                    <td>
                      <?php 
                        $statusClasses = [
                          'pending' => 'bg-warning bg-opacity-10 text-warning',
                          'processing' => 'bg-info bg-opacity-10 text-info',
                          'completed' => 'bg-success bg-opacity-10 text-success',
                          'cancelled' => 'bg-danger bg-opacity-10 text-danger'
                        ];
                        $statusClass = $statusClasses[$order['status']] ?? 'bg-secondary bg-opacity-10 text-secondary';
                      ?>
                      <span class="badge rounded-pill <?= $statusClass ?> px-3 py-2">
                        <?= ucfirst($order['status']) ?>
                      </span>
                    </td>
                    <td>
                      <a href="orders.php?id=<?= $order['order_id'] ?>" 
                         class="btn btn-sm btn-primary rounded-pill px-3">
                        <i class="bi bi-eye me-1"></i> View
                      </a>
                    </td>
                  </tr>
                <?php endforeach; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>      <!-- Low Stock Products -->
      <?php
      $lowStockList = $pdo->query("
          SELECT p.*, o.name as org_name
          FROM products p
          LEFT JOIN organizations o ON p.org_id = o.org_id
          WHERE p.stock <= 5
          ORDER BY p.stock ASC
          LIMIT 5
      ")->fetchAll();
      
      if (!empty($lowStockList)):
      ?>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Low Stock Alert</h5>
            <a href="/pns_store/admin/products.php" class="btn btn-sm btn-warning">
              Manage Stock
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="ps-3">Product</th>
                  <th>Organization</th>
                  <th>Price</th>
                  <th class="pe-3">Stock</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach($lowStockList as $product): ?>
                <tr>
                  <td class="ps-3">
                    <div class="d-flex align-items-center">
                      <?php if($product['image']): ?>
                        <img src="/pns_store/assets/uploads/<?=htmlspecialchars($product['image'])?>" 
                             class="rounded me-2" style="width: 32px; height: 32px; object-fit: cover;">
                      <?php else: ?>
                        <div class="bg-light rounded me-2" style="width: 32px; height: 32px;"></div>
                      <?php endif; ?>
                      <div><?=htmlspecialchars($product['title'])?></div>
                    </div>
                  </td>
                  <td><?=htmlspecialchars($product['org_name'] ?? '-')?></td>
                  <td>₱<?=number_format($product['price'], 2)?></td>
                  <td class="pe-3">
                    <span class="badge bg-danger"><?=$product['stock']?></span>
                  </td>
                </tr>
                <?php endforeach; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <?php endif; ?>
    </div>
    
    <!-- Right Column -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="/pns_store/admin/products.php" class="btn btn-outline-success">
              <i class="bi bi-box-seam me-2"></i>Manage Products
            </a>
            <a href="/pns_store/admin/orders.php" class="btn btn-outline-primary">
              <i class="bi bi-cart-check me-2"></i>Process Orders
            </a>
            <a href="/pns_store/admin/organizations.php" class="btn btn-outline-warning">
              <i class="bi bi-buildings me-2"></i>Manage Organizations
            </a>
            <a href="/pns_store/admin/users.php" class="btn btn-outline-info">
              <i class="bi bi-people me-2"></i>Manage Users
            </a>
          </div>
        </div>
      </div>

      <!-- Monthly Stats -->
      <?php
      $monthStart = date('Y-m-01 00:00:00');
      $monthEnd = date('Y-m-t 23:59:59');
      
      $monthlyStats = $pdo->query("
          SELECT COUNT(*) as order_count,
                 COALESCE(SUM(total_amount), 0) as revenue,
                 COUNT(DISTINCT user_id) as unique_customers
          FROM orders
          WHERE created_at BETWEEN '$monthStart' AND '$monthEnd'
      ")->fetch();
      ?>
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">Monthly Overview</h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <small class="text-muted d-block mb-1">Total Orders</small>
            <h4 class="mb-0"><?=number_format($monthlyStats['order_count'])?></h4>
          </div>
          <div class="mb-4">
            <small class="text-muted d-block mb-1">Total Revenue</small>
            <h4 class="mb-0">₱<?=number_format($monthlyStats['revenue'], 2)?></h4>
          </div>
          <div>
            <small class="text-muted d-block mb-1">Unique Customers</small>
            <h4 class="mb-0"><?=number_format($monthlyStats['unique_customers'])?></h4>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<?php require_once __DIR__ . '/../includes/footer.php'; ?>